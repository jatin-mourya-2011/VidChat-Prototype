<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VidChat - Real-Time App</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Load icon library -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal { transition: opacity 0.25s ease; }
        .modal-content { transition: transform 0.25s ease; }
        #toast {
            visibility: hidden; min-width: 250px; margin-left: -125px;
            background-color: #333; color: #fff; text-align: center;
            border-radius: 8px; padding: 16px; position: fixed;
            z-index: 100; left: 50%; bottom: 30px; opacity: 0;
            transition: visibility 0.5s, opacity 0.5s linear;
        }
        #toast.show { visibility: visible; opacity: 1; }
        /* Full-screen, scroll-snapping reel container */
        .reels-active { overflow: hidden; }
        #reels-page.reels-active {
            height: 100vh; overflow-y: scroll; scroll-snap-type: y mandatory;
            -ms-overflow-style: none; scrollbar-width: none;
        }
        #reels-page.reels-active::-webkit-scrollbar { display: none; }
        #reels-page .reel-item {
            height: 100vh; width: 100%; scroll-snap-align: start; flex-shrink: 0;
        }
        /* Style for radio buttons */
        .form-radio {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            display: inline-block;
            vertical-align: middle;
            background-origin: border-box;
            user-select: none;
            flex-shrink: 0;
            border-radius: 100%;
            border-width: 2px;
            border-color: #6b7280; /* gray-500 */
        }
        .form-radio:checked {
            border-color: #4f46e5; /* indigo-600 */
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3ccircle cx='8' cy='8' r='3'/%3e%3c/svg%3e");
            background-color: #4f46e5; /* indigo-600 */
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Header -->
    <header id="main-header" class="bg-white shadow-md sticky top-0 z-50">
        <nav class="container mx-auto max-w-4xl px-4 py-3 flex justify-between items-center">
            <div class="text-2xl font-bold text-indigo-600">
                Vid<span class="text-red-500">Chat</span>
            </div>
            <div class="flex items-center space-x-4">
                <button id="desktop-create-btn" class="text-gray-600 hover:text-indigo-600 text-2xl hidden md:block">
                    <i class="fas fa-video"></i>
                </button>
                <button id="how-to-earn-btn" class="text-gray-600 hover:text-indigo-600 font-medium hidden md:flex">
                    <i class="fas fa-question-circle mr-1"></i>
                    How to Earn
                </button>
                <div id="wallet" class="bg-yellow-100 text-yellow-800 font-bold px-4 py-2 rounded-full shadow-inner">
                    ✨ <span id="spark-balance">...</span> Sparks
                </div>
            </div>
        </nav>
    </header>

    <!-- Home Page -->
    <main id="home-page" class="page-content container mx-auto max-w-6xl p-4 mt-6 pb-24">
        
        <!-- Daily Reward Banner -->
        <div class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white p-5 rounded-lg shadow-lg mb-6 flex items-center justify-between">
            <div>
                <h2 class="text-xl font-bold">Welcome Back!</h2>
                <p id="bonus-subtitle" class="text-indigo-100">Claim your daily engagement bonus.</p>
            </div>
            <button id="claim-bonus-btn" class="bg-white text-indigo-600 font-bold px-5 py-2 rounded-full shadow-md hover:bg-gray-100 transition duration-300">
                Claim 10 ✨
            </button>
        </div>

        <!-- Social Feed Section -->
        <!-- This is now a container that Firebase will fill -->
        <div id="video-grid-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Loading Message -->
            <p id="loading-posts" class="text-gray-600 text-center col-span-3">Loading videos...</p>
            <!-- Videos will be dynamically inserted here -->
        </div>
    </main>

    <!-- Create Page -->
    <main id="create-page" class="page-content container mx-auto max-w-lg p-4 mt-6 pb-24 hidden">
        <!-- We wrap this in a form for easy submission -->
        <form id="create-post-form" class="bg-white rounded-lg shadow-md p-8 text-center">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Create New Post</h2>
            
            <!-- Upload Box -->
            <div class="border-4 border-dashed border-gray-300 rounded-lg p-12 flex flex-col items-center justify-center">
                <i class="fas fa-cloud-upload-alt text-7xl text-indigo-400"></i>
                <p class="text-gray-600 mt-4 mb-6">Drag & drop your video here</p>
                <button type="button" class="bg-indigo-600 text-white font-bold px-6 py-3 rounded-full shadow-md hover:bg-indigo-700 transition duration-300">
                    Select File
                </button>
                <p class="text-sm text-gray-500 mt-2">(Prototype: Just fill the fields below)</p>
            </div>

            <!-- NEW: Post Type Toggle -->
            <div class="flex justify-center space-x-6 mt-6">
                <label class="flex items-center cursor-pointer">
                    <input type="radio" name="postType" value="video" class="form-radio h-4 w-4 text-indigo-600 border-gray-400 focus:ring-indigo-500" checked>
                    <span class="ml-2 text-gray-700 font-medium">Video (Home Feed)</span>
                </label>
                <label class="flex items-center cursor-pointer">
                    <input type="radio" name="postType" value="reel" class="form-radio h-4 w-4 text-indigo-600 border-gray-400 focus:ring-indigo-500">
                    <span class="ml-2 text-gray-700 font-medium">Reel (Reels Feed)</span>
                </label>
            </div>

            <input id="post-title" class="w-full border border-gray-300 rounded-lg p-3 mt-6 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Title or Description..." required />
            <input id="post-thumbnail" class="w-full border border-gray-300 rounded-lg p-3 mt-4 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Thumbnail/Poster URL (e.g., https://placehold.co/...)" required />
            
            <button type="submit" id="upload-btn" class="bg-red-500 text-white font-bold px-8 py-3 rounded-full shadow-md hover:bg-red-600 transition duration-300 mt-4 w-full">
                Upload
            </button>
        </form>
    </main>
    
    <!-- Reels Page (Dynamic Container) -->
    <main id="reels-page" class="page-content hidden">
        <!-- Loading Message -->
        <p id="loading-reels" class="text-white text-center text-lg absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">Loading reels...</p>
        <!-- Reels will be dynamically inserted here -->
    </main>

    <!-- Chats Page (Placeholder) -->
    <main id="chats-page" class="page-content container mx-auto max-w-xl p-0 mt-6 pb-24 hidden">
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <h2 class="text-2xl font-bold text-gray-800 p-4 border-b">Chats</h2>
            <div class="divide-y divide-gray-200">
                <div class="p-4 flex items-center space-x-4 hover:bg-gray-50 cursor-pointer"><img src="https://placehold.co/50x50/93c5fd/333?text=A" alt="Avatar" class="w-12 h-12 rounded-full"><div class="flex-1"><h3 class="font-bold text-gray-800">Creator Alice</h3><p class="text-sm text-gray-600">Awesome! Thanks for the tip!</p></div><span class="text-xs text-gray-500">10m ago</span></div>
                <div class="p-4 flex items-center space-x-4 hover:bg-gray-50 cursor-pointer"><img src="https://placehold.co/50x50/86efac/333?text=C" alt="Avatar" class="w-12 h-12 rounded-full"><div class="flex-1"><h3 class="font-bold text-gray-800">Creator Charlie</h3><p class="text-sm text-gray-600">You're welcome!</p></div><span class="text-xs text-gray-500">1h ago</span></div>
            </div>
        </div>
    </main>

    <!-- Account Page (Placeholder) -->
    <main id="account-page" class="page-content container mx-auto max-w-xl p-4 mt-6 pb-24 hidden">
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex flex-col items-center">
                <img src="https://placehold.co/100x100/fca5a5/333?text=U" alt="Your Avatar" class="w-24 h-24 rounded-full shadow-lg">
                <h2 id="account-username" class="text-2xl font-bold text-gray-800 mt-4">User (You)</h2>
                <p id="account-userid" class="text-gray-600 text-sm">Loading user...</p>
                <div id="wallet-profile" class="bg-yellow-100 text-yellow-800 font-bold px-4 py-2 rounded-full shadow-inner mt-4">
                    ✨ <span id="spark-balance-profile">...</span> Sparks
                </div>
            </div>
            <div class="flex justify-around text-center my-6 border-y py-4">
                <div><p class="text-2xl font-bold">12</p><p class="text-gray-500 text-sm">Following</p></div>
                <div><p class="text-2xl font-bold">5</p><p class="text-gray-500 text-sm">Followers</p></div>
                <div><p class="text-2xl font-bold">0</p><p id="user-post-count" class="text-gray-500 text-sm">Posts</p></div>
            </div>
            <div class="space-y-2">
                <a href="#" class="flex items-center justify-between p-3 bg-gray-100 rounded-lg hover:bg-gray-200"><span class="font-medium"><i class="fas fa-wallet mr-2"></i> My Wallet</span><i class="fas fa-chevron-right text-gray-500"></i></a>
                <a href="#" class="flex items-center justify-between p-3 bg-gray-100 rounded-lg hover:bg-gray-200"><span class="font-medium"><i class="fas fa-cog mr-2"></i> Settings</span><i class="fas fa-chevron-right text-gray-500"></i></a>
                <a href="#" class="flex items-center justify-between p-3 bg-gray-100 rounded-lg hover:bg-gray-200 text-red-600"><span class="font-medium"><i class="fas fa-sign-out-alt mr-2"></i> Log Out</span><i class="fas fa-chevron-right"></i></a>
            </div>
        </div>
    </main>

    <!-- Bottom Navigation Bar (Mobile Only) -->
    <nav class="md:hidden fixed bottom-0 left-0 right-0 z-50 bg-white shadow-[0_-2px_6px_rgba(0,0,0,0.06)] border-t border-gray-200">
        <div class="flex justify-around items-center h-16">
            <a href="#" id="nav-create" class="nav-button flex flex-col items-center justify-center text-gray-500 hover:text-indigo-600 w-1/5" data-page="create-page"><i class="fas fa-plus-square text-xl"></i><span class="text-xs mt-1">Create</span></a>
            <a href="#" id="nav-reels" class="nav-button flex flex-col items-center justify-center text-gray-500 hover:text-indigo-600 w-1/5" data-page="reels-page"><i class="fas fa-film text-xl"></i><span class="text-xs mt-1">Reels</span></a>
            <a href="#" id="nav-home" class="nav-button flex flex-col items-center justify-center text-indigo-600 font-medium w-1/5" data-page="home-page"><i class="fas fa-home text-xl"></i><span class="text-xs mt-1">Home</span></a>
            <a href="#" id="nav-chats" class="nav-button flex flex-col items-center justify-center text-gray-500 hover:text-indigo-600 w-1/5" data-page="chats-page"><i class="fas fa-comments text-xl"></i><span class="text-xs mt-1">Chats</span></a>
            <a href="#" class="nav-button flex flex-col items-center justify-center text-gray-500 hover:text-indigo-600 w-1/5" data-page="account-page"><i class="fas fa-user-circle text-xl"></i><span class="text-xs mt-1">Account</span></a>
        </div>
    </nav>
    
    <!-- "How to Earn" Modal -->
    <div id="earn-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-lg p-6 m-4 transform -translate-y-10">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800">How to Earn Sparks ✨</h2>
                <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            <div class="space-y-6">
                <div><h3 class="text-lg font-semibold text-indigo-600 mb-2">💰 For Users (You!)</h3><ul class="list-disc list-inside space-y-2 text-gray-700"><li><strong>Daily Login Bonus:</strong> Get free Sparks just for visiting each day.</li><li><strong>Engage-to-Earn:</strong> Tip creators to reward good content.</li><li><strong>Curation Bonus:</strong> Tip a video *before* it gets popular to earn a large Spark bonus.</li><li><strong>Watch Ads:</strong> Watch short sponsored ads to earn extra Sparks.</li></ul></div>
                <div><h3 class="text-lg font-semibold text-yellow-600 mb-2">🎨 For Creators</h3><ul class="list-disc list-inside space-y-2 text-gray-700"><li><strong>Creator Pool:</strong> A percentage of all app revenue (from ads and Spark sales) goes into a "Daily Creator Pool." This pool is distributed to the top-performing *videos* each day.</li></ul></div>
                <div><h3 class="text-lg font-semibold text-gray-700 mb-2">What can I do with Sparks?</h3><p class="text-gray-700">Accumulate Sparks and cash them out for real money (e.g., 10,000 ✨ = $10) or spend them on exclusive digital items.</p></div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast"></div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            updateDoc, 
            collection, 
            onSnapshot,
            addDoc,
            writeBatch,
            increment,
            serverTimestamp,
            query,
            limit,
            getDocs // Added getDocs for checking if empty
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL STATE ---
        let db, auth;
        let currentUserId = null;
        let currentUserData = {};
        let postsColRef;
        let reelsColRef; // NEW: Collection for Reels
        
        // --- UI ELEMENTS ---
        const sparkBalanceEl = document.getElementById('spark-balance');
        const sparkBalanceProfileEl = document.getElementById('spark-balance-profile');
        const toastEl = document.getElementById('toast');
        const modal = document.getElementById('earn-modal');
        const openModalBtn = document.getElementById('how-to-earn-btn');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const claimBonusBtn = document.getElementById('claim-bonus-btn');
        const bonusSubtitle = document.getElementById('bonus-subtitle');
        const videoGridContainer = document.getElementById('video-grid-container');
        const loadingPostsEl = document.getElementById('loading-posts');
        const reelsPageContainer = document.getElementById('reels-page'); // NEW: Reels container
        const loadingReelsEl = document.getElementById('loading-reels'); // NEW: Reels loading
        const createPostForm = document.getElementById('create-post-form');
        const uploadBtn = document.getElementById('upload-btn');
        const accountUserIdEl = document.getElementById('account-userid');
        const userPostCountEl = document.getElementById('user-post-count'); // For Account page

        // --- FIREBASE CONFIG (Mandatory) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const userProvidedConfig = {
          apiKey: "AIzaSyDa1qEbObnYVIpMvXoF8afXBvcG-DhR_uY",
          authDomain: "vidchat-2011.firebaseapp.com",
          projectId: "vidchat-2011",
          storageBucket: "vidchat-2011.firebasestorage.app",
          messagingSenderId: "1091989305105",
          appId: "1:1091989305105:web:f6da79a45105151b0dfeb0",
          measurementId: "G-SM1VE2SE0B"
        };
        const firebaseConfig = typeof __firebase_config !== 'undefined' && __firebase_config !== '{}'
            ? JSON.parse(__firebase_config) 
            : userProvidedConfig;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;


        // --- TOAST FUNCTION ---
        function showToast(message) {
            toastEl.textContent = message;
            toastEl.className = "show";
            setTimeout(() => { 
                toastEl.className = toastEl.className.replace("show", ""); 
            }, 3000);
        }

        // --- FIREBASE INITIALIZATION ---
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Initialize collection references
                postsColRef = collection(db, "posts");
                reelsColRef = collection(db, "reels"); // NEW

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        accountUserIdEl.textContent = `User ID: ${currentUserId.substring(0, 8)}...`;
                        
                        await setupUserDocument(currentUserId);
                        listenToUserDocument(currentUserId);
                        
                        // Start listening to both collections
                        listenToPosts();
                        listenToReels(); // NEW

                    } else {
                        currentUserId = null;
                        currentUserData = {};
                        updateSparkBalance(0);
                        accountUserIdEl.textContent = "Not logged in.";
                    }
                });

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

            } catch (error) {
                console.error("Firebase Init Error:", error);
                showToast("Error connecting to app services.");
            }
        }

        // --- USER DATA FUNCTIONS ---
        async function setupUserDocument(userId) {
            const userDocRef = doc(db, "users", userId); 
            const userDocSnap = await getDoc(userDocRef);
            if (!userDocSnap.exists()) {
                await setDoc(userDocRef, {
                    uid: userId,
                    username: "AnonymousUser",
                    sparkBalance: 100,
                    lastBonusClaim: null,
                    postCount: 0
                });
                showToast("Welcome! You've received 100 Sparks! ✨");
            }
        }

        function listenToUserDocument(userId) {
            const userDocRef = doc(db, "users", userId);
            onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    currentUserData = docSnap.data();
                    updateSparkBalance(currentUserData.sparkBalance);
                    checkBonusButtonState(currentUserData.lastBonusClaim);
                    document.getElementById('account-username').textContent = currentUserData.username;
                    userPostCountEl.textContent = currentUserData.postCount || 0;
                }
            });
        }

        function updateSparkBalance(balance) {
            sparkBalanceEl.textContent = balance;
            sparkBalanceProfileEl.textContent = balance;
        }

        function checkBonusButtonState(lastClaimTimestamp) {
            if (lastClaimTimestamp) {
                const lastClaimDate = lastClaimTimestamp.toDate().toDateString();
                const todayDate = new Date().toDateString();
                if (lastClaimDate === todayDate) {
                    claimBonusBtn.disabled = true;
                    bonusSubtitle.textContent = "You've claimed your bonus for today.";
                    claimBonusBtn.textContent = "Claimed";
                    claimBonusBtn.classList.remove('bg-white', 'text-indigo-600', 'hover:bg-gray-100');
                    claimBonusBtn.classList.add('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
                } else {
                    claimBonusBtn.disabled = false;
                    bonusSubtitle.textContent = "Claim your daily engagement bonus.";
                    claimBonusBtn.textContent = "Claim 10 ✨";
                    claimBonusBtn.classList.add('bg-white', 'text-indigo-600', 'hover:bg-gray-100');
                    claimBonusBtn.classList.remove('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
                }
            } else {
                claimBonusBtn.disabled = false;
                bonusSubtitle.textContent = "Claim your daily engagement bonus.";
                claimBonusBtn.textContent = "Claim 10 ✨";
            }
        }

        // --- POST/VIDEO DATA FUNCTIONS (HOME PAGE) ---
        async function populateStarterVideos() {
            if (!postsColRef) return;
            const q = query(postsColRef, limit(1));
            const snapshot = await getDocs(q);
            if (snapshot.empty) {
                console.log("Database 'posts' is empty. Adding starter videos...");
                const batch = writeBatch(db);
                const starterVideos = [
                    { title: "Welcome to VidChat!", thumbnailUrl: "https://placehold.co/600x400/8b5cf6/ffffff?text=Welcome!", creatorUsername: "VidChat Team", creatorId: "system", sparkCount: 25, createdAt: serverTimestamp() },
                    { title: "My First Short Film", thumbnailUrl: "https://placehold.co/600x400/ec4899/ffffff?text=Short+Film", creatorUsername: "CreatorAlice", creatorId: "alice123", sparkCount: 10, createdAt: serverTimestamp() },
                    { title: "How to Earn Sparks", thumbnailUrl: "https://placehold.co/600x400/f59e0b/ffffff?text=Earn+✨", creatorUsername: "VidChat Team", creatorId: "system", sparkCount: 42, createdAt: serverTimestamp() }
                ];
                starterVideos.forEach(video => batch.set(doc(postsColRef), video));
                await batch.commit();
            }
        }

        function listenToPosts() {
            if (!postsColRef) return;
            populateStarterVideos().then(() => {
                const q = query(postsColRef);
                onSnapshot(q, (querySnapshot) => {
                    videoGridContainer.innerHTML = ''; // Clear
                    if (querySnapshot.empty) {
                        loadingPostsEl.textContent = "No videos posted yet. Be the first!";
                        videoGridContainer.appendChild(loadingPostsEl);
                        return;
                    }
                    querySnapshot.forEach((doc) => createPostElement(doc.id, doc.data()));
                }, (error) => {
                    console.error("Error listening to posts:", error);
                    loadingPostsEl.textContent = "Error loading videos.";
                });
            });
        }

        function createPostElement(postId, post) {
            const article = document.createElement('article');
            article.className = "bg-white rounded-lg shadow-md overflow-hidden post";
            article.dataset.postId = postId;

            let timestamp = "Just now";
            if (post.createdAt && post.createdAt.toDate) {
                const date = post.createdAt.toDate();
                const seconds = Math.floor((new Date() - date) / 1000);
                if (seconds > 3600) timestamp = `${Math.floor(seconds / 3600)}h ago`;
                else if (seconds > 60) timestamp = `${Math.floor(seconds / 60)}m ago`;
                else if (seconds > 0) timestamp = `${seconds}s ago`;
            }

            article.innerHTML = `
                <img src="${post.thumbnailUrl}" alt="Video thumbnail" class="rounded-t-lg w-full h-48 object-cover" onerror="this.src='https://placehold.co/600x400/ef4444/ffffff?text=Image+Error'">
                <div class="p-4">
                    <div class="flex space-x-3">
                        <img src="https://placehold.co/40x40/93c5fd/333?text=${post.creatorUsername.charAt(0).toUpperCase()}" alt="Creator Avatar" class="w-10 h-10 rounded-full mt-1">
                        <div class="flex-1">
                            <h3 class="font-bold text-gray-800 text-lg">${post.title}</h3>
                            <p class="text-sm text-gray-600">${post.creatorUsername}</p>
                            <p class="text-sm text-gray-500">${timestamp}</p>
                        </div>
                    </div>
                    <div class="mt-4 flex justify-between items-center">
                        <button class="tip-button text-indigo-600 hover:text-indigo-800 font-semibold py-2 px-4 rounded-full bg-indigo-100 hover:bg-indigo-200 transition">
                            <i class="fas fa-star mr-1"></i> Tip 1 ✨
                        </button>
                        <div class="text-lg font-bold text-yellow-600">
                            <span class="spark-total">${post.sparkCount || 0}</span> ✨
                        </div>
                    </div>
                </div>
            `;
            
            const tipButton = article.querySelector('.tip-button');
            tipButton.addEventListener('click', (e) => {
                e.stopPropagation();
                handleTip(postId, tipButton, 'posts'); // UPDATED: Pass collection name
            });
            
            videoGridContainer.prepend(article);
        }
        
        // --- NEW: REELS DATA FUNCTIONS (REELS PAGE) ---
        async function populateStarterReels() {
            if (!reelsColRef) return;
            const q = query(reelsColRef, limit(1));
            const snapshot = await getDocs(q);
            if (snapshot.empty) {
                console.log("Database 'reels' is empty. Adding starter reels...");
                const batch = writeBatch(db);
                const starterReels = [
                    { title: "My first VidChat Reel! #fyp", thumbnailUrl: "https://placehold.co/400x700/000000/ffffff?text=Reel+1", creatorUsername: "CreatorAlice", creatorId: "alice123", sparkCount: 88, likeCount: 1200, commentCount: 105, createdAt: serverTimestamp() },
                    { title: "Travel goals! ✈️ #travel", thumbnailUrl: "https://placehold.co/400x700/333333/ffffff?text=Reel+2", creatorUsername: "CreatorCharlie", creatorId: "charlie456", sparkCount: 150, likeCount: 3400, commentCount: 210, createdAt: serverTimestamp() }
                ];
                starterReels.forEach(reel => batch.set(doc(reelsColRef), reel));
                await batch.commit();
            }
        }

        function listenToReels() {
            if (!reelsColRef) return;
            populateStarterReels().then(() => {
                const q = query(reelsColRef); // Can add orderBy('createdAt', 'desc')
                onSnapshot(q, (querySnapshot) => {
                    reelsPageContainer.innerHTML = ''; // Clear
                    if (querySnapshot.empty) {
                        loadingReelsEl.textContent = "No reels posted yet.";
                        reelsPageContainer.appendChild(loadingReelsEl);
                        return;
                    }
                    querySnapshot.forEach((doc) => createReelElement(doc.id, doc.data()));
                }, (error) => {
                    console.error("Error listening to reels:", error);
                    loadingReelsEl.textContent = "Error loading reels.";
                });
            });
        }

        function createReelElement(reelId, reel) {
            const div = document.createElement('div');
            div.className = "reel-item bg-black relative w-full overflow-hidden";
            div.dataset.reelId = reelId;

            div.innerHTML = `
                <img src="${reel.thumbnailUrl}" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/400x700/ef4444/ffffff?text=Image+Error'">
                <div class="absolute bottom-20 left-0 p-4 text-white" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">
                    <p class="font-bold">@${reel.creatorUsername}</p>
                    <p class="text-sm">${reel.title}</p>
                </div>
                <div class="absolute bottom-20 right-2 flex flex-col space-y-5 text-white text-2xl" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">
                    <button class="flex flex-col items-center"><i class="fas fa-heart"></i><span class="text-sm font-semibold">${reel.likeCount || 0}</span></button>
                    <button class="flex flex-col items-center"><i class="fas fa-comment"></i><span class="text-sm font-semibold">${reel.commentCount || 0}</span></button>
                    <!-- DYNAMIC TIP BUTTON FOR REELS -->
                    <button class="tip-button-reel flex flex-col items-center text-yellow-300">
                        <i class="fas fa-star"></i>
                        <span class="spark-total text-sm font-semibold">${reel.sparkCount || 0}</span>
                    </button>
                    <button class="flex flex-col items-center"><i class="fas fa-share"></i><span class="text-sm font-semibold">Share</span></button>
                </div>
            `;
            
            // Add tip button event listener
            const tipButton = div.querySelector('.tip-button-reel');
            tipButton.addEventListener('click', (e) => {
                e.stopPropagation();
                handleTip(reelId, tipButton, 'reels'); // UPDATED: Pass collection name
            });

            reelsPageContainer.appendChild(div);
        }

        // --- EVENT HANDLERS ---

        // Handle Daily Bonus Claim
        claimBonusBtn.addEventListener('click', async () => {
            if (!currentUserId) return;
            claimBonusBtn.disabled = true;
            const userDocRef = doc(db, "users", currentUserId);
            try {
                await updateDoc(userDocRef, {
                    sparkBalance: increment(10),
                    lastBonusClaim: serverTimestamp()
                });
                showToast("🎁 10 Sparks claimed!");
            } catch (error) {
                console.error("Error claiming bonus: ", error);
                showToast("Error claiming bonus. Try again.");
                claimBonusBtn.disabled = false;
            }
        });

        // Handle Tipping (NOW DYNAMIC)
        async function handleTip(docId, tipButton, collectionName) {
            if (!currentUserId || !collectionName) return;
            if (currentUserData.sparkBalance < 1) {
                showToast("❌ You're out of Sparks! Claim your daily bonus.");
                return;
            }
            
            tipButton.disabled = true;

            const userDocRef = doc(db, "users", currentUserId);
            // Use the correct collection based on the parameter
            const contentDocRef = doc(db, collectionName, docId); 

            try {
                const batch = writeBatch(db);
                batch.update(userDocRef, { sparkBalance: increment(-1) });
                batch.update(contentDocRef, { sparkCount: increment(1) });
                await batch.commit();
                
                showToast("✨ You tipped 1 Spark!");

                // Curation bonus logic
                const postSnap = await getDoc(contentDocRef);
                const newSparkCount = postSnap.data().sparkCount;
                if (newSparkCount === 10) {
                     await updateDoc(userDocRef, { sparkBalance: increment(20) });
                     showToast("🎉 Curation Bonus! +20 Sparks");
                }

            } catch (error) {
                console.error("Error tipping post: ", error);
                showToast("Error tipping. Please try again.");
            } finally {
                setTimeout(() => { if (tipButton) tipButton.disabled = false; }, 1000);
            }
        }

        // Handle Create Post (NOW DYNAMIC)
        createPostForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUserId) return;

            const title = document.getElementById('post-title').value;
            const thumbnailUrl = document.getElementById('post-thumbnail').value;
            // Get the selected post type
            const postType = document.querySelector('input[name="postType"]:checked').value;

            if (!title || !thumbnailUrl) {
                showToast("Please fill out all fields.");
                return;
            }
            
            uploadBtn.disabled = true;
            uploadBtn.textContent = "Uploading...";

            // Determine which collection to save to
            const targetColRef = (postType === 'video') ? postsColRef : reelsColRef;
            
            try {
                const batch = writeBatch(db);

                // 1. Create the new post/reel
                const newContentData = {
                    title: title,
                    thumbnailUrl: thumbnailUrl,
                    creatorId: currentUserId,
                    creatorUsername: currentUserData.username || "AnonymousUser",
                    sparkCount: 0,
                    createdAt: serverTimestamp()
                };
                
                // Add reel-specific fields if it's a reel
                if (postType === 'reel') {
                    newContentData.likeCount = 0;
                    newContentData.commentCount = 0;
                }
                
                batch.set(doc(targetColRef), newContentData);

                // 2. Update the user's post count
                const userDocRef = doc(db, "users", currentUserId);
                batch.update(userDocRef, { postCount: increment(1) });
                
                await batch.commit();

                showToast("✅ Content Uploaded!");
                createPostForm.reset();
                
                // Switch to the correct page to see the new post
                if (postType === 'video') {
                    document.getElementById('nav-home').click();
                } else {
                    document.getElementById('nav-reels').click();
                }

            } catch (error) {
                console.error("Error uploading post: ", error);
                showToast("Upload failed. Please try again.");
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = "Upload";
            }
        });


        // --- PAGE NAVIGATION (Simplified) ---
        const navButtons = document.querySelectorAll('.nav-button');
        const pages = document.querySelectorAll('.page-content');
        const mainHeader = document.getElementById('main-header');
        const bodyEl = document.body;
        const navAccountButton = document.querySelector('a[data-page="account-page"]'); // Fixed selector

        navButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                e.preventDefault();
                const targetPageId = button.dataset.page;
                
                // Handle Reels-specific layout
                if (targetPageId === 'reels-page') {
                    mainHeader.classList.add('hidden');
                    bodyEl.classList.add('reels-active');
                    document.getElementById('reels-page').classList.add('reels-active');
                } else {
                    mainHeader.classList.remove('hidden');
                    bodyEl.classList.remove('reels-active');
                    document.getElementById('reels-page').classList.remove('reels-active');
                }

                pages.forEach(page => page.classList.add('hidden'));
                const targetPage = document.getElementById(targetPageId);
                if (targetPage) {
                    targetPage.classList.remove('hidden');
                } else {
                    console.error('Page not found:', targetPageId);
                }

                navButtons.forEach(btn => {
                    btn.classList.remove('text-indigo-600', 'font-medium');
                    btn.classList.add('text-gray-500');
                });
                button.classList.add('text-indigo-600', 'font-medium');
                button.classList.remove('text-gray-500');

                if (targetPageId !== 'reels-page') window.scrollTo(0, 0);
            });
        });
        
        document.getElementById('desktop-create-btn').addEventListener('click', () => {
             document.getElementById('nav-create').click();
        });

        // --- MODAL (How to Earn) ---
        openModalBtn.addEventListener('click', () => {
            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.querySelector('.modal-content').classList.remove('-translate-y-10');
        });
        closeModalBtn.addEventListener('click', () => {
            modal.classList.add('opacity-0', 'pointer-events-none');
            modal.querySelector('.modal-content').classList.add('-translate-y-10');
        });
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModalBtn.click();
        });

        // --- START THE APP ---
        initializeFirebase();

    </script>
</body>
</html>

