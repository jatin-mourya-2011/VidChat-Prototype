<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VidChat - Real-Time App</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Load icon library -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* A class for all main app UI that should be hidden before login */
        .app-content {
            display: none;
        }
        .modal { transition: opacity 0.25s ease; }
        .modal-content { transition: transform 0.25s ease; }
        #toast {
            visibility: hidden; min-width: 250px; margin-left: -125px;
            background-color: #333; color: #fff; text-align: center;
            border-radius: 8px; padding: 16px; position: fixed;
            z-index: 100; left: 50%; bottom: 30px; opacity: 0;
            transition: visibility 0.5s, opacity 0.5s linear;
        }
        #toast.show { visibility: visible; opacity: 1; }
        /* Full-screen, scroll-snapping reel container */
        .reels-active { overflow: hidden; }
        #reels-page.reels-active {
            height: 100vh; overflow-y: scroll; scroll-snap-type: y mandatory;
            -ms-overflow-style: none; scrollbar-width: none;
        }
        #reels-page.reels-active::-webkit-scrollbar { display: none; }
        #reels-page .reel-item {
            height: 100vh; width: 100%; scroll-snap-align: start; flex-shrink: 0;
        }
        /* Style for radio buttons */
        .form-radio {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            display: inline-block;
            vertical-align: middle;
            background-origin: border-box;
            user-select: none;
            flex-shrink: 0;
            border-radius: 100%;
            border-width: 2px;
            border-color: #6b7280; /* gray-500 */
        }
        .form-radio:checked {
            border-color: #4f46e5; /* indigo-600 */
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3ccircle cx='8' cy='8' r='3'/%3e%3c/svg%3e");
            background-color: #4f46e5; /* indigo-600 */
        }
        /* Style for liked (solid red) heart */
        .liked .fa-heart {
            font-weight: 900; /* 'fas' solid style */
            color: #ef4444; /* red-500 */
        }
        /* Style for default (outline) heart */
        .fa-heart {
            font-weight: 400; /* 'far' regular style */
        }
        /* Hide default file input */
        #thumbnail-file-input, #video-file-input {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- NEW: Login Page (Visible by default) -->
    <main id="login-page" class="page-content container mx-auto max-w-sm p-4 mt-20 text-center">
        <div class="bg-white p-8 rounded-2xl shadow-xl">
            <h1 class="text-4xl font-bold text-indigo-600">
                Vid<span class="text-red-500">Chat</span>
            </h1>
            <p class="text-gray-600 mt-4">The social app where everyone earns.</p>
            <p id="auth-loading" class="text-gray-500 mt-8">Connecting...</p>
            <button id="google-login-btn" class="hidden mt-8 w-full bg-blue-600 text-white font-bold px-4 py-3 rounded-lg shadow-md hover:bg-blue-700 transition duration-300 flex items-center justify-center space-x-2">
                <i class="fab fa-google"></i>
                <span>Sign in with Google</span>
            </button>
        </div>
    </main>

    <!-- NEW: Complete Profile Page (Hidden by default) -->
    <main id="complete-profile-page" class="page-content container mx-auto max-w-lg p-4 mt-12 pb-24 hidden">
        <form id="complete-profile-form" class="bg-white rounded-lg shadow-md p-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Welcome! Let's get you set up.</h2>
            
            <div class="flex flex-col items-center">
                <img id="profile-setup-pic-img" src="https://placehold.co/100x100/fca5a5/333?text=?" alt="Your Avatar" class="w-24 h-24 rounded-full shadow-lg">
            </div>

            <div class="mt-4">
                <label for="profile-setup-username" class="block text-sm font-medium text-gray-700">Username (required)</label>
                <input id="profile-setup-username" type="text" class="w-full border border-gray-300 rounded-lg p-3 mt-1 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="e.g. CreatorAlice" required />
                <p class="text-xs text-gray-500 mt-1">This is your unique @name. No spaces.</p>
            </div>

            <div class="mt-4">
                <label for="profile-setup-displayname" class="block text-sm font-medium text-gray-700">Display Name</label>
                <input id="profile-setup-displayname" type="text" class="w-full border border-gray-300 rounded-lg p-3 mt-1 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Your full name" />
            </div>
            
            <div class="mt-4">
                <label for="profile-setup-bio" class="block text-sm font-medium text-gray-700">Bio</label>
                <textarea id="profile-setup-bio" class="w-full border border-gray-300 rounded-lg p-3 mt-1 focus:outline-none focus:ring-2 focus:ring-indigo-500" rows="3" placeholder="Tell us about yourself..."></textarea>
            </div>
            
            <div class="mt-4">
                <label for="profile-setup-pic-url" class="block text-sm font-medium text-gray-700">Profile Picture URL</label>
                <input id="profile-setup-pic-url" type="text" class="w-full border border-gray-300 rounded-lg p-3 mt-1 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="https://..." />
            </div>

            <button type="submit" id="save-new-profile-btn" class="bg-indigo-600 text-white font-bold px-8 py-3 rounded-full shadow-md hover:bg-indigo-700 transition duration-300 mt-6 w-full">
                Save and Continue
            </button>
        </form>
    </main>

    <!-- Header (NOW HIDDEN BY DEFAULT) -->
    <header id="main-header" class="app-content bg-white shadow-md sticky top-0 z-50">
        <nav class="container mx-auto max-w-4xl px-4 py-3 flex justify-between items-center">
            <div class="text-2xl font-bold text-indigo-600">
                Vid<span class="text-red-500">Chat</span>
            </div>
            <div class="flex items-center space-x-4">
                <button id="desktop-create-btn" class="text-gray-600 hover:text-indigo-600 text-2xl hidden md:block">
                    <i class="fas fa-video"></i>
                </button>
                <button id="how-to-earn-btn" class="text-gray-600 hover:text-indigo-600 font-medium hidden md:flex">
                    <i class="fas fa-question-circle mr-1"></i>
                    How to Earn
                </button>
                <div id="wallet" class="bg-yellow-100 text-yellow-800 font-bold px-4 py-2 rounded-full shadow-inner">
                    âœ¨ <span id="spark-balance">...</span> Sparks
                </div>
            </div>
        </nav>
    </header>

    <!-- Home Page (HIDDEN BY DEFAULT) -->
    <main id="home-page" class="app-content page-content container mx-auto max-w-6xl p-4 mt-6 pb-24 hidden">
        
        <!-- Daily Reward Banner -->
        <div class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white p-5 rounded-lg shadow-lg mb-6 flex items-center justify-between">
            <div>
                <h2 class="text-xl font-bold">Welcome Back, <span id="welcome-username">User</span>!</h2>
                <p id="bonus-subtitle" class="text-indigo-100">Claim your daily engagement bonus.</p>
            </div>
            <button id="claim-bonus-btn" class="bg-white text-indigo-600 font-bold px-5 py-2 rounded-full shadow-md hover:bg-gray-100 transition duration-300">
                Claim 10 âœ¨
            </button>
        </div>

        <!-- Social Feed Section -->
        <div id="video-grid-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <p id="loading-posts" class="text-gray-600 text-center col-span-3">Loading videos...</p>
        </div>
    </main>

    <!-- Create Page (HIDDEN BY DEFAULT) -->
    <main id="create-page" class="app-content page-content container mx-auto max-w-lg p-4 mt-6 pb-24 hidden">
        <form id="create-post-form" class="bg-white rounded-lg shadow-md p-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Create New Post</h2>
            
            <!-- NEW: Video File Upload -->
            <div class="mb-6">
                <label class="block text-lg font-medium text-gray-800 mb-2">Step 1: Upload Video</label>
                <input type="file" id="video-file-input" accept="video/*" />
                <button type="button" id="video-upload-btn" class="w-full bg-indigo-600 text-white font-bold px-4 py-3 rounded-lg hover:bg-indigo-700 transition duration-300 flex items-center justify-center space-x-2">
                    <i class="fas fa-video"></i>
                    <span>Select Video File</span>
                </button>
                <div id="video-preview-container" class="hidden mt-4 text-center">
                    <video id="video-preview-player" controls class="w-full rounded-lg shadow-md bg-black"></video>
                    <p id="video-file-name" class="text-sm text-gray-600 mt-2"></p>
                </div>
            </div>

            <!-- Post Type Toggle -->
            <div class="flex justify-center space-x-6">
                <label class="flex items-center cursor-pointer">
                    <input type="radio" name="postType" value="video" class="form-radio h-4 w-4 text-indigo-600 border-gray-400 focus:ring-indigo-500" checked>
                    <span class="ml-2 text-gray-700 font-medium">Video (Home Feed)</span>
                </label>
                <label class="flex items-center cursor-pointer">
                    <input type="radio" name="postType" value="reel" class="form-radio h-4 w-4 text-indigo-600 border-gray-400 focus:ring-indigo-500">
                    <span class="ml-2 text-gray-700 font-medium">Reel (Reels Feed)</span>
                </label>
            </div>

            <!-- Title Input -->
            <input id="post-title" class="w-full border border-gray-300 rounded-lg p-3 mt-6 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Title or Description..." required />
            
            <!-- NEW: Thumbnail File Upload -->
            <div class="mt-4">
                <label class="block text-lg font-medium text-gray-800 mb-2">Step 2: Upload Thumbnail</label>
                <input type="file" id="thumbnail-file-input" accept="image/*" />
                <button type="button" id="thumbnail-upload-btn" class="w-full bg-gray-200 text-gray-700 font-bold px-4 py-3 rounded-lg hover:bg-gray-300 transition duration-300 flex items-center justify-center space-x-2">
                    <i class="fas fa-camera"></i>
                    <span>Select Thumbnail</span>
                </button>
                <div id="thumbnail-preview-container" class="hidden mt-4 text-center">
                    <img id="thumbnail-preview-img" src="#" alt="Thumbnail Preview" class="w-32 h-32 object-cover rounded-lg inline-block shadow-md" />
                    <p id="thumbnail-file-name" class="text-sm text-gray-600 mt-2"></p>
                </div>
            </div>
            
            <button type="submit" id="upload-btn" class="bg-red-500 text-white font-bold px-8 py-3 rounded-full shadow-md hover:bg-red-600 transition duration-300 mt-6 w-full">
                Publish Post
            </button>
        </form>
    </main>
    
    <!-- Reels Page (HIDDEN BY DEFAULT) -->
    <main id="reels-page" class="app-content page-content hidden">
        <p id="loading-reels" class="text-white text-center text-lg absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">Loading reels...</p>
    </main>

    <!-- Chats Page (HIDDEN BY DEFAULT) -->
    <main id="chats-page" class="app-content page-content container mx-auto max-w-xl p-0 mt-6 pb-24 hidden">
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <h2 class="text-2xl font-bold text-gray-800 p-4 border-b">Chats</h2>
            <div class="divide-y divide-gray-200">
                <div class="p-4 flex items-center space-x-4 hover:bg-gray-50 cursor-pointer"><img src="https://placehold.co/50x50/93c5fd/333?text=A" alt="Avatar" class="w-12 h-12 rounded-full"><div class="flex-1"><h3 class="font-bold text-gray-800">Creator Alice</h3><p class="text-sm text-gray-600">Awesome! Thanks for the tip!</p></div><span class="text-xs text-gray-500">10m ago</span></div>
                <div class="p-4 flex items-center space-x-4 hover:bg-gray-50 cursor-pointer"><img src="https://placehold.co/50x50/86efac/333?text=C" alt="Avatar" class="w-12 h-12 rounded-full"><div class="flex-1"><h3 class="font-bold text-gray-800">Creator Charlie</h3><p class="text-sm text-gray-600">You're welcome!</p></div><span class="text-xs text-gray-500">1h ago</span></div>
            </div>
        </div>
    </main>

    <!-- Account Page (HIDDEN BY DEFAULT) -->
    <main id="account-page" class="app-content page-content container mx-auto max-w-xl p-4 mt-6 pb-24 hidden">
        <div class="bg-white rounded-lg shadow-md p-6">
            <!-- Profile Info Section -->
            <div id="profile-view" class="text-center">
                <div class="flex flex-col items-center">
                    <img id="profile-pic-img" src="https://placehold.co/100x100/fca5a5/333?text=U" alt="Your Avatar" class="w-24 h-24 rounded-full shadow-lg">
                    <h2 id="account-username" class="text-2xl font-bold text-gray-800 mt-4">User (You)</h2>
                    <p id="account-bio" class="text-gray-600 mt-1 max-w-md">This is your bio! Click "Edit Profile" to change it.</p>
                    <p id="account-userid" class="text-gray-600 text-sm mt-2">Loading user...</p>
                    <div id="wallet-profile" class="bg-yellow-100 text-yellow-800 font-bold px-4 py-2 rounded-full shadow-inner mt-4">
                        âœ¨ <span id="spark-balance-profile">...</span> Sparks
                    </div>
                </div>
                <button id="edit-profile-btn" class="mt-4 bg-indigo-600 text-white font-bold px-5 py-2 rounded-full shadow-md hover:bg-indigo-700 transition duration-300">
                    Edit Profile
                </button>
            </div>

            <!-- Profile Edit Section (Hidden by default) -->
            <form id="profile-edit-view" class="hidden text-center">
                <div class="flex flex-col items-center">
                    <img id="profile-edit-pic-img" src="https://placehold.co/100x100/fca5a5/333?text=U" alt="Your Avatar" class="w-24 h-24 rounded-full shadow-lg">
                    
                    <!-- NEW: Show non-editable username -->
                    <div class="w-full mt-4">
                        <label class="block text-sm font-medium text-left text-gray-700">Username</label>
                        <input id="username-display-disabled" type="text" class="w-full bg-gray-100 border border-gray-300 rounded-lg p-3 mt-1 focus:outline-none text-gray-500" disabled />
                    </div>

                    <!-- FIX: Update ID and placeholder -->
                    <div class="w-full mt-4">
                        <label class="block text-sm font-medium text-left text-gray-700">Display Name</label>
                        <input id="displayname-input" class="w-full border border-gray-300 rounded-lg p-3 mt-1 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Your Display Name..." />
                    </div>

                    <div class="w-full mt-4">
                        <label class="block text-sm font-medium text-left text-gray-700">Profile Picture URL</label>
                        <input id="profile-pic-url-input" class="w-full border border-gray-300 rounded-lg p-2 mt-1 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Profile Picture URL..." />
                    </div>
                    
                    <div class="w-full mt-4">
                        <label class="block text-sm font-medium text-left text-gray-700">Bio</label>
                        <textarea id="bio-input" class="w-full border border-gray-300 rounded-lg p-2 mt-1 focus:outline-none focus:ring-2 focus:ring-indigo-500" rows="3" placeholder="Your Bio..."></textarea>
                    </div>
                </div>
                <div class="flex space-x-4 justify-center mt-4">
                    <button id="cancel-edit-btn" type="button" class="bg-gray-200 text-gray-800 font-bold px-5 py-2 rounded-full shadow-md hover:bg-gray-300 transition duration-300">
                        Cancel
                    </button>
                    <button id="save-profile-btn" type="submit" class="bg-green-500 text-white font-bold px-5 py-2 rounded-full shadow-md hover:bg-green-600 transition duration-300">
                        Save Changes
                    </button>
                </div>
            </form>

            <!-- Stats (Followers still placeholder) -->
            <div class="flex justify-around text-center my-6 border-y py-4">
                <div><p class="text-2xl font-bold">12</p><p class="text-gray-500 text-sm">Following</p></div>
                <div><p class="text-2xl font-bold">5</p><p class="text-gray-500 text-sm">Followers</p></div>
                <div><p id="user-post-count-display" class="text-2xl font-bold">0</p><p class="text-gray-500 text-sm">Posts</p></div>
            </div>
            <!-- Links (Logout now works) -->
            <div class="space-y-2">
                <a href="#" class="flex items-center justify-between p-3 bg-gray-100 rounded-lg hover:bg-gray-200"><span class="font-medium"><i class="fas fa-wallet mr-2"></i> My Wallet</span><i class="fas fa-chevron-right text-gray-500"></i></a>
                <a href="#" class="flex items-center justify-between p-3 bg-gray-100 rounded-lg hover:bg-gray-200"><span class="font-medium"><i class="fas fa-cog mr-2"></i> Settings</span><i class="fas fa-chevron-right text-gray-500"></i></a>
                <a href="#" id="logout-btn" class="flex items-center justify-between p-3 bg-gray-100 rounded-lg hover:bg-gray-200 text-red-600">
                    <span class="font-medium"><i class="fas fa-sign-out-alt mr-2"></i> Log Out</span>
                    <i class="fas fa-chevron-right"></i>
                </a>
            </div>
        </div>
    </main>

    <!-- Bottom Navigation Bar (HIDDEN BY DEFAULT) -->
    <nav id="bottom-nav-bar" class="app-content md:hidden fixed bottom-0 left-0 right-0 z-50 bg-white shadow-[0_-2px_6px_rgba(0,0,0,0.06)] border-t border-gray-200">
        <div class="flex justify-around items-center h-16">
            <a href="#" id="nav-create" class="nav-button flex flex-col items-center justify-center text-gray-500 hover:text-indigo-600 w-1/5" data-page="create-page"><i class="fas fa-plus-square text-xl"></i><span class="text-xs mt-1">Create</span></a>
            <a href="#" id="nav-reels" class="nav-button flex flex-col items-center justify-center text-gray-500 hover:text-indigo-600 w-1/5" data-page="reels-page"><i class="fas fa-film text-xl"></i><span class="text-xs mt-1">Reels</span></a>
            <a href="#" id="nav-home" class="nav-button flex flex-col items-center justify-center text-indigo-600 font-medium w-1/5" data-page="home-page"><i class="fas fa-home text-xl"></i><span class="text-xs mt-1">Home</span></a>
            <a href="#" id="nav-chats" class="nav-button flex flex-col items-center justify-center text-gray-500 hover:text-indigo-600 w-1/5" data-page="chats-page"><i class="fas fa-comments text-xl"></i><span class="text-xs mt-1">Chats</span></a>
            <a href="#" class="nav-button flex flex-col items-center justify-center text-gray-500 hover:text-indigo-600 w-1/5" data-page="account-page"><i class="fas fa-user-circle text-xl"></i><span class="text-xs mt-1">Account</span></a>
        </div>
    </nav>
    
    <!-- "How to Earn" Modal -->
    <div id="earn-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-lg p-6 m-4 transform -translate-y-10">
            <!-- Modal content... -->
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800">How to Earn Sparks âœ¨</h2>
                <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            <div class="space-y-6">
                <div><h3 class="text-lg font-semibold text-indigo-600 mb-2">ðŸ’° For Users (You!)</h3><ul class="list-disc list-inside space-y-2 text-gray-700"><li><strong>Daily Login Bonus:</strong> Get free Sparks just for visiting each day.</li><li><strong>Engage-to-Earn:</strong> Tip creators to reward good content.</li><li><strong>Curation Bonus:</strong> Tip a video *before* it gets popular to earn a large Spark bonus.</li><li><strong>Watch Ads:</strong> Watch short sponsored ads to earn extra Sparks.</li></ul></div>
                <div><h3 class="text-lg font-semibold text-yellow-600 mb-2">ðŸŽ¨ For Creators</h3><ul class="list-disc list-inside space-y-2 text-gray-700"><li><strong>Creator Pool:</strong> A percentage of all app revenue (from ads and Spark sales) goes into a "Daily Creator Pool." This pool is distributed to the top-performing *videos* each day.</li></ul></div>
                <div><h3 class="text-lg font-semibold text-gray-700 mb-2">What can I do with Sparks?</h3><p class="text-gray-700">Accumulate Sparks and cash them out for real money (e.g., 10,000 âœ¨ = $10) or spend them on exclusive digital items.</p></div>
            </div>
        </div>
    </div>
    
    <!-- Video Player Modal -->
    <div id="video-player-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-75 opacity-0 pointer-events-none">
        <div class="modal-content bg-black w-full max-w-lg transform -translate-y-10">
            <video id="modal-video-player" class="w-full" controls autoplay playsinline></video>
            <button id="close-video-modal-btn" class="absolute top-2 right-2 text-white text-3xl">&times;</button>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast"></div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        // Firebase Imports - UPDATED TO 12.4.0
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged,
            GoogleAuthProvider, // NEW: Import Google Auth
            signInWithPopup     // NEW: Import Sign-in method
        } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            updateDoc, 
            collection, 
            onSnapshot,
            writeBatch,
            increment,
            serverTimestamp,
            query,
            limit,
            getDocs,
            arrayUnion,
            arrayRemove
        } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

        // --- GLOBAL STATE ---
        let db, auth;
        let currentUserId = null;
        let currentUserData = {};
        let postsColRef;
        let reelsColRef;
        let selectedThumbnailFile = null;
        let selectedVideoFile = null;
        
        // --- UI ELEMENTS ---
        const sparkBalanceEl = document.getElementById('spark-balance');
        const sparkBalanceProfileEl = document.getElementById('spark-balance-profile');
        const toastEl = document.getElementById('toast');
        const modal = document.getElementById('earn-modal');
        const openModalBtn = document.getElementById('how-to-earn-btn');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const claimBonusBtn = document.getElementById('claim-bonus-btn');
        const bonusSubtitle = document.getElementById('bonus-subtitle');
        const welcomeUsername = document.getElementById('welcome-username');
        const videoGridContainer = document.getElementById('video-grid-container');
        const loadingPostsEl = document.getElementById('loading-posts');
        const reelsPageContainer = document.getElementById('reels-page');
        const loadingReelsEl = document.getElementById('loading-reels');
        
        // --- Create Page UI ---
        const createPostForm = document.getElementById('create-post-form');
        const uploadBtn = document.getElementById('upload-btn');
        const thumbnailFileInput = document.getElementById('thumbnail-file-input');
        const thumbnailUploadBtn = document.getElementById('thumbnail-upload-btn');
        const thumbnailPreviewContainer = document.getElementById('thumbnail-preview-container');
        const thumbnailPreviewImg = document.getElementById('thumbnail-preview-img');
        const thumbnailFileName = document.getElementById('thumbnail-file-name');
        const videoFileInput = document.getElementById('video-file-input');
        const videoUploadBtn = document.getElementById('video-upload-btn');
        const videoPreviewContainer = document.getElementById('video-preview-container');
        const videoPreviewPlayer = document.getElementById('video-preview-player');
        const videoFileName = document.getElementById('video-file-name');
        
        // --- Account Page UI ---
        const accountUserIdEl = document.getElementById('account-userid');
        const userPostCountDisplayEl = document.getElementById('user-post-count-display');
        const accountUsernameEl = document.getElementById('account-username');
        const accountBioEl = document.getElementById('account-bio');
        const profilePicImgEl = document.getElementById('profile-pic-img');
        const profileViewEl = document.getElementById('profile-view');
        const profileEditViewEl = document.getElementById('profile-edit-view');
        const editProfileBtn = document.getElementById('edit-profile-btn');
        const saveProfileBtn = document.getElementById('save-profile-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const displaynameInput = document.getElementById('displayname-input'); // FIX: Was usernameInput
        const bioInput = document.getElementById('bio-input');
        const profilePicUrlInput = document.getElementById('profile-pic-url-input');
        const profileEditPicImgEl = document.getElementById('profile-edit-pic-img');
        const logoutBtn = document.getElementById('logout-btn');
        const usernameDisplayDisabled = document.getElementById('username-display-disabled'); // NEW
        
        // --- Video Player Modal UI ---
        const videoPlayerModal = document.getElementById('video-player-modal');
        const modalVideoPlayer = document.getElementById('modal-video-player');
        const closeVideoModalBtn = document.getElementById('close-video-modal-btn');
        
        // --- App Containers ---
        const loginPage = document.getElementById('login-page');
        const authLoading = document.getElementById('auth-loading');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const mainHeader = document.getElementById('main-header');
        const bottomNavBar = document.getElementById('bottom-nav-bar');
        const appContentElements = document.querySelectorAll('.app-content'); // Main app container
        const homePage = document.getElementById('home-page'); // Default page
        
        // --- NEW: Complete Profile Page UI ---
        const completeProfilePage = document.getElementById('complete-profile-page');
        const completeProfileForm = document.getElementById('complete-profile-form');

        // --- FIREBASE CONFIG (Mandatory) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const userProvidedConfig = {
            apiKey: "AIzaSyAcBqHhJfwhcwCg2zvSkmP_fKWC34lbdos",
            authDomain: "vidchat-new.firebaseapp.com",
            projectId: "vidchat-new",
            storageBucket: "vidchat-new.firebasestorage.app",
            messagingSenderId: "236995445201",
            appId: "1:236995445201:web:58cc3fbc0dc3aeca3960f0",
            measurementId: "G-XTZHL6PTZH"
        };
        const firebaseConfig = typeof __firebase_config !== 'undefined' && __firebase_config !== '{}'
            ? JSON.parse(__firebase_config) 
            : userProvidedConfig;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- CLOUDINARY CONFIG ---
        const CLOUDINARY_CLOUD_NAME = 'dpq8izmc8';
        const CLOUDINARY_UPLOAD_PRESET = 'vidchat_preset';

        // --- TOAST FUNCTION ---
        function showToast(message) {
            toastEl.textContent = message;
            toastEl.className = "show";
            setTimeout(() => { 
                toastEl.className = toastEl.className.replace("show", ""); 
            }, 3000);
        }
        
        // --- NEW: Helper function to show/hide app
        function showAppUI(isLoggedIn) {
            if (isLoggedIn) {
                appContentElements.forEach(el => el.style.display = ''); // Show app
                homePage.style.display = ''; // Show home by default
                bottomNavBar.style.display = 'flex'; // Fix for nav
                mainHeader.style.display = 'block'; // Fix for header
                loginPage.style.display = 'none';
                completeProfilePage.style.display = 'none';
            } else {
                appContentElements.forEach(el => el.style.display = 'none'); // Hide app
                loginPage.style.display = 'block';
                completeProfilePage.style.display = 'none';
            }
        }

        // --- FIREBASE INITIALIZATION ---
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                postsColRef = collection(db, "posts");
                reelsColRef = collection(db, "reels");

                // --- NEW AUTH FLOW ---
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        const userDocRef = doc(db, "users", user.uid);
                        const userDocSnap = await getDoc(userDocRef);

                        if (userDocSnap.exists()) {
                            // --- EXISTING USER ---
                            listenToUserDocument(currentUserId);
                            listenToPosts();
                            listenToReels();
                            showAppUI(true); // Show the main app
                        } else {
                            // --- NEW USER ---
                            // Show the "Complete Profile" page
                            loginPage.style.display = 'none';
                            completeProfilePage.style.display = 'block';
                            
                            // Pre-fill the form with Google data
                            document.getElementById('profile-setup-pic-img').src = user.photoURL || `https://placehold.co/100x100/fca5a5/333?text=${user.displayName.charAt(0).toUpperCase()}`;
                            document.getElementById('profile-setup-pic-url').value = user.photoURL || '';
                            document.getElementById('profile-setup-displayname').value = user.displayName || '';
                        }
                    } else {
                        // --- LOGGED OUT ---
                        currentUserId = null;
                        currentUserData = {};
                        updateSparkBalance(0);
                        showAppUI(false); // Show the login page
                    }
                    // Show login button once auth is ready
                    authLoading.style.display = 'none';
                    googleLoginBtn.style.display = 'flex';
                });

            } catch (error) {
                console.error("Firebase Init Error:", error);
                showToast("Error connecting to app services.");
                authLoading.textContent = "Error. Please refresh.";
            }
        }

        // --- NEW: Complete Profile Form Submission ---
        completeProfileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUserId) return;

            const username = document.getElementById('profile-setup-username').value.replace(/ /g, ''); // Remove spaces
            const displayName = document.getElementById('profile-setup-displayname').value;
            
            if (!username) {
                showToast("Please enter a username.");
                return;
            }
            
            // Note: A real app would check if username is unique here.
            // We will skip that for simplicity for now.
            
            const saveBtn = document.getElementById('save-new-profile-btn');
            saveBtn.disabled = true;
            saveBtn.textContent = "Saving...";

            try {
                const userDocRef = doc(db, "users", currentUserId);
                await setDoc(userDocRef, {
                    uid: currentUserId,
                    username: username,
                    displayName: displayName,
                    bio: document.getElementById('profile-setup-bio').value,
                    profilePicUrl: document.getElementById('profile-setup-pic-url').value || `https://placehold.co/100x100/fca5a5/333?text=${username.charAt(0).toUpperCase()}`,
                    sparkBalance: 100,
                    lastBonusClaim: null,
                    postCount: 0,
                    likedContent: []
                });
                
                // Now, load the app
                listenToUserDocument(currentUserId);
                listenToPosts();
                listenToReels();
                showAppUI(true);
                
                showToast(`Welcome, @${username}! You've received 100 Sparks! âœ¨`);

            } catch (error) {
                console.error("Error creating profile:", error);
                showToast("Error saving profile. Please try again.");
                saveBtn.disabled = false;
                saveBtn.textContent = "Save and Continue";
            }
        });


        // --- USER DATA FUNCTIONS ---
        // (setupUserDocument is now removed)
        function listenToUserDocument(userId) {
            const userDocRef = doc(db, "users", userId);
            onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    currentUserData = docSnap.data();
                    updateSparkBalance(currentUserData.sparkBalance);
                    checkBonusButtonState(currentUserData.lastBonusClaim);
                    
                    // Update welcome message
                    welcomeUsername.textContent = currentUserData.username || "User";
                    
                    // Update Account Page
                    accountUsernameEl.textContent = `@${currentUserData.username}`;
                    accountBioEl.textContent = currentUserData.bio;
                    userPostCountDisplayEl.textContent = currentUserData.postCount || 0;
                    
                    const picUrl = currentUserData.profilePicUrl || `https://placehold.co/100x100/fca5a5/333?text=${currentUserData.username.charAt(0).toUpperCase()}`;
                    profilePicImgEl.src = picUrl;
                    profileEditPicImgEl.src = picUrl;

                    displaynameInput.value = currentUserData.displayName; // FIX: Was usernameInput
                    usernameDisplayDisabled.value = `@${currentUserData.username}`; // NEW
                    bioInput.value = currentUserData.bio;
                    profilePicUrlInput.value = currentUserData.profilePicUrl;
                }
            });
        }

        function updateSparkBalance(balance) {
            sparkBalanceEl.textContent = balance;
            sparkBalanceProfileEl.textContent = balance;
        }

        function checkBonusButtonState(lastClaimTimestamp) {
            if (lastClaimTimestamp) {
                const lastClaimDate = lastClaimTimestamp.toDate().toDateString();
                const todayDate = new Date().toDateString();
                if (lastClaimDate === todayDate) {
                    claimBonusBtn.disabled = true;
                    bonusSubtitle.textContent = "You've claimed your bonus for today.";
                    claimBonusBtn.textContent = "Claimed";
                    claimBonusBtn.classList.add('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
                    claimBonusBtn.classList.remove('bg-white', 'text-indigo-600', 'hover:bg-gray-100');
                } else {
                    claimBonusBtn.disabled = false;
                    bonusSubtitle.textContent = "Claim your daily engagement bonus.";
                    claimBonusBtn.textContent = "Claim 10 âœ¨";
                    claimBonusBtn.classList.remove('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
                    claimBonusBtn.classList.add('bg-white', 'text-indigo-600', 'hover:bg-gray-100');
                }
            } else {
                claimBonusBtn.disabled = false;
                bonusSubtitle.textContent = "Claim your daily engagement bonus.";
                claimBonusBtn.textContent = "Claim 10 âœ¨";
            }
        }

        // --- POST/VIDEO DATA FUNCTIONS (HOME PAGE) ---
        async function populateStarterVideos() {
            if (!postsColRef) return;
            const q = query(postsColRef, limit(1));
            const snapshot = await getDocs(q);
            if (snapshot.empty) {
                console.log("Database 'posts' is empty. Adding starter videos...");
                const batch = writeBatch(db);
                const starterVideos = [
                    { title: "Welcome to VidChat!", videoUrl: "https://res.cloudinary.com/demo/video/upload/c_scale,w_400/dog.mp4", thumbnailUrl: "https://res.cloudinary.com/demo/video/upload/c_scale,w_400/dog.jpg", creatorUsername: "VidChatTeam", creatorProfilePic: "https://placehold.co/40x40/8b5cf6/333?text=V", creatorId: "system", sparkCount: 25, likeCount: 15, createdAt: serverTimestamp() },
                    { title: "My First Short Film", videoUrl: "https://res.cloudinary.com/demo/video/upload/c_scale,w_400/sample.mp4", thumbnailUrl: "https://res.cloudinary.com/demo/video/upload/c_scale,w_400/sample.jpg", creatorUsername: "CreatorAlice", creatorProfilePic: "https://placehold.co/40x40/93c5fd/333?text=A", creatorId: "alice123", sparkCount: 10, likeCount: 5, createdAt: serverTimestamp() },
                ];
                starterVideos.forEach(video => batch.set(doc(postsColRef), video));
                await batch.commit();
            }
        }

        function listenToPosts() {
            if (!postsColRef) return;
            populateStarterVideos().then(() => {
                const q = query(postsColRef);
                onSnapshot(q, (querySnapshot) => {
                    videoGridContainer.innerHTML = '';
                    if (querySnapshot.empty) {
                        loadingPostsEl.textContent = "No videos posted yet. Be the first!";
                        videoGridContainer.appendChild(loadingPostsEl);
                        return;
                    }
                    querySnapshot.forEach((doc) => createPostElement(doc.id, doc.data()));
                }, (error) => {
                    console.error("Error listening to posts:", error);
                    loadingPostsEl.textContent = "Error loading videos.";
                });
            });
        }

        function createPostElement(postId, post) {
            const article = document.createElement('article');
            article.className = "bg-white rounded-lg shadow-md overflow-hidden post";
            article.dataset.postId = postId;

            let timestamp = "Just now";
            if (post.createdAt && post.createdAt.toDate) {
                const date = post.createdAt.toDate();
                const seconds = Math.floor((new Date() - date) / 1000);
                if (seconds > 3600) timestamp = `${Math.floor(seconds / 3600)}h ago`;
                else if (seconds > 60) timestamp = `${Math.floor(seconds / 60)}m ago`;
                else if (seconds > 0) timestamp = `${seconds}s ago`;
            }

            const isLiked = currentUserData.likedContent && currentUserData.likedContent.includes(postId);

            article.innerHTML = `
                <div class="relative cursor-pointer play-video-btn">
                    <img src="${post.thumbnailUrl}" alt="Video thumbnail" class="rounded-t-lg w-full h-48 object-cover" onerror="this.src='https://placehold.co/600x400/ef4444/ffffff?text=Image+Error'">
                    <div class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-30 opacity-0 hover:opacity-100 transition-opacity">
                        <i class="fas fa-play text-white text-5xl"></i>
                    </div>
                </div>
                <div class="p-4">
                    <div class="flex space-x-3">
                        <img src="${post.creatorProfilePic || 'https://placehold.co/40x40/93c5fd/333?text=' + post.creatorUsername.charAt(0).toUpperCase()}" alt="Creator Avatar" class="w-10 h-10 rounded-full mt-1">
                        <div class="flex-1">
                            <h3 class="font-bold text-gray-800 text-lg">${post.title}</h3>
                            <p class="text-sm text-gray-600">@${post.creatorUsername}</p>
                            <p class="text-sm text-gray-500">${timestamp}</p>
                        </div>
                    </div>
                    <div class="mt-4 flex justify-between items-center">
                        <div class="flex space-x-4">
                            <button class="like-button text-gray-500 hover:text-red-500 transition ${isLiked ? 'liked' : ''}">
                                <i class="fas fa-heart text-xl"></i>
                                <span class="like-count text-sm ml-1">${post.likeCount || 0}</span>
                            </button>
                            <button class="text-gray-500 hover:text-indigo-600 transition">
                                <i class="fas fa-comment text-xl"></i>
                            </button>
                        </div>
                        <button class="tip-button text-indigo-600 hover:text-indigo-800 font-semibold py-2 px-4 rounded-full bg-indigo-100 hover:bg-indigo-200 transition">
                            <i class="fas fa-star mr-1"></i> Tip 1 âœ¨
                        </button>
                    </div>
                    <div class="mt-2 flex justify-end">
                         <div class="text-lg font-bold text-yellow-600">
                            <span class="spark-total">${post.sparkCount || 0}</span> âœ¨
                        </div>
                    </div>
                </div>
            `;
            
            const tipButton = article.querySelector('.tip-button');
            tipButton.addEventListener('click', (e) => { e.stopPropagation(); handleTip(postId, 'posts'); });
            
            const likeButton = article.querySelector('.like-button');
            likeButton.addEventListener('click', (e) => { e.stopPropagation(); handleLike(postId, 'posts', likeButton); });
            
            const playButton = article.querySelector('.play-video-btn');
            playButton.addEventListener('click', (e) => {
                e.stopPropagation();
                if (post.videoUrl) {
                    modalVideoPlayer.src = post.videoUrl;
                    videoPlayerModal.classList.remove('opacity-0', 'pointer-events-none');
                    videoPlayerModal.querySelector('.modal-content').classList.remove('-translate-y-10');
                } else {
                    showToast("Video not available.");
                }
            });
            
            videoGridContainer.prepend(article);
        }
        
        // --- REELS DATA FUNCTIONS (REELS PAGE) ---
        async function populateStarterReels() {
            if (!reelsColRef) return;
            const q = query(reelsColRef, limit(1));
            const snapshot = await getDocs(q);
            if (snapshot.empty) {
                console.log("Database 'reels' is empty. Adding starter reels...");
                const batch = writeBatch(db);
                const starterReels = [
                    { title: "My first VidChat Reel! #fyp", videoUrl: "https://res.cloudinary.com/demo/video/upload/c_scale,w_400/dog.mp4", thumbnailUrl: "https://res.cloudinary.com/demo/video/upload/c_scale,w_400/dog.jpg", creatorUsername: "CreatorAlice", creatorProfilePic: "https://placehold.co/40x40/93c5fd/333?text=A", creatorId: "alice123", sparkCount: 88, likeCount: 1200, commentCount: 105, createdAt: serverTimestamp() },
                    { title: "Travel goals! âœˆï¸ #travel", videoUrl: "https://res.cloudinary.com/demo/video/upload/c_scale,w_400/sample.mp4", thumbnailUrl: "https://res.cloudinary.com/demo/video/upload/c_scale,w_400/sample.jpg", creatorUsername: "CreatorCharlie", creatorProfilePic: "https://placehold.co/40x40/86efac/333?text=C", creatorId: "charlie456", sparkCount: 150, likeCount: 3400, commentCount: 210, createdAt: serverTimestamp() }
                ];
                starterReels.forEach(reel => batch.set(doc(reelsColRef), reel));
                await batch.commit();
            }
        }

        function listenToReels() {
            if (!reelsColRef) return;
            populateStarterReels().then(() => {
                const q = query(reelsColRef);
                onSnapshot(q, (querySnapshot) => {
                    reelsPageContainer.innerHTML = '';
                    if (querySnapshot.empty) {
                        loadingReelsEl.textContent = "No reels posted yet.";
                        reelsPageContainer.appendChild(loadingReelsEl);
                        return;
                    }
                    querySnapshot.forEach((doc) => createReelElement(doc.id, doc.data()));
                }, (error) => {
                    console.error("Error listening to reels:", error);
                    loadingReelsEl.textContent = "Error loading reels.";
                });
            });
        }

        function createReelElement(reelId, reel) {
            const div = document.createElement('div');
            div.className = "reel-item bg-black relative w-full overflow-hidden";
            div.dataset.reelId = reelId;
            const isLiked = currentUserData.likedContent && currentUserData.likedContent.includes(reelId);

            div.innerHTML = `
                <video class="w-full h-full object-cover" 
                       src="${reel.videoUrl}" 
                       poster="${reel.thumbnailUrl}" 
                       loop 
                       muted 
                       playsinline
                       onerror="this.poster='https://placehold.co/400x700/ef4444/ffffff?text=Video+Error'">
                </video>
                <div class="absolute bottom-20 left-0 p-4 text-white" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">
                    <div class="flex items-center space-x-2">
                        <img src="${reel.creatorProfilePic || 'https://placehold.co/40x40/93c5fd/333?text=' + reel.creatorUsername.charAt(0).toUpperCase()}" alt="Creator Avatar" class="w-10 h-10 rounded-full border-2 border-white">
                        <p class="font-bold">@${reel.creatorUsername}</p>
                    </div>
                    <p class="text-sm mt-2">${reel.title}</p>
                </div>
                <div class="absolute bottom-20 right-2 flex flex-col space-y-5 text-white text-2xl" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">
                    <button class="like-button-reel flex flex-col items-center ${isLiked ? 'liked' : ''}">
                        <i class="fas fa-heart"></i>
                        <span class="like-count text-sm font-semibold">${reel.likeCount || 0}</span>
                    </button>
                    <button class="flex flex-col items-center"><i class="fas fa-comment"></i><span class="text-sm font-semibold">${reel.commentCount || 0}</span></button>
                    <button class="tip-button-reel flex flex-col items-center text-yellow-300">
                        <i class="fas fa-star"></i>
                        <span class="spark-total text-sm font-semibold">${reel.sparkCount || 0}</span>
                    </button>
                    <button class="flex flex-col items-center"><i class="fas fa-share"></i><span class="text-sm font-semibold">Share</span></button>
                </div>
            `;
            
            const tipButton = div.querySelector('.tip-button-reel');
            tipButton.addEventListener('click', (e) => { e.stopPropagation(); handleTip(reelId, 'reels'); });
            
            const likeButton = div.querySelector('.like-button-reel');
            likeButton.addEventListener('click', (e) => { e.stopPropagation(); handleLike(reelId, 'reels', likeButton); });
            
            const video = div.querySelector('video');
            const observer = new IntersectionObserver((entries) => {
                if (entries[0].isIntersecting) video.play();
                else video.pause();
            }, { threshold: 0.5 });
            observer.observe(video);

            reelsPageContainer.appendChild(div);
        }

        // --- EVENT HANDLERS ---
        
        // NEW: Handle Google Sign-In
        googleLoginBtn.addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
                // onAuthStateChanged will handle the rest
            } catch (error) {
                console.error("Error signing in with Google:", error);
                showToast("Error signing in. Please try again.");
            }
        });

        // NEW: Handle Log Out
        logoutBtn.addEventListener('click', () => {
            auth.signOut();
        });

        // Handle Daily Bonus Claim
        claimBonusBtn.addEventListener('click', async () => {
            if (!currentUserId) return;
            claimBonusBtn.disabled = true;
            const userDocRef = doc(db, "users", currentUserId);
            try {
                await updateDoc(userDocRef, { sparkBalance: increment(10), lastBonusClaim: serverTimestamp() });
                showToast("ðŸŽ 10 Sparks claimed!");
            } catch (error) {
                claimBonusBtn.disabled = false;
            }
        });

        // Handle Tipping
        async function handleTip(docId, collectionName) {
            if (!currentUserId || !collectionName) return;
            if (currentUserData.sparkBalance < 1) {
                showToast("âŒ You're out of Sparks! Claim your daily bonus.");
                return;
            }
            const userDocRef = doc(db, "users", currentUserId);
            const contentDocRef = doc(db, collectionName, docId); 
            try {
                const batch = writeBatch(db);
                batch.update(userDocRef, { sparkBalance: increment(-1) });
                batch.update(contentDocRef, { sparkCount: increment(1) });
                await batch.commit();
                showToast("âœ¨ You tipped 1 Spark!");
                const postSnap = await getDoc(contentDocRef);
                if (postSnap.data().sparkCount === 10) {
                     await updateDoc(userDocRef, { sparkBalance: increment(20) });
                     showToast("ðŸŽ‰ Curation Bonus! +20 Sparks");
                }
            } catch (error) { console.error("Error tipping post: ", error); }
        }
        
        // Handle Liking
        async function handleLike(docId, collectionName, likeButton) {
            if (!currentUserId) return;
            const userDocRef = doc(db, "users", currentUserId);
            const contentDocRef = doc(db, collectionName, docId);
            const isCurrentlyLiked = currentUserData.likedContent && currentUserData.likedContent.includes(docId);
            const likeCountEl = likeButton.querySelector('.like-count');
            let currentLikeCount = parseInt(likeCountEl.textContent);
            try {
                const batch = writeBatch(db);
                if (isCurrentlyLiked) {
                    batch.update(userDocRef, { likedContent: arrayRemove(docId) });
                    batch.update(contentDocRef, { likeCount: increment(-1) });
                    likeButton.classList.remove('liked');
                    likeCountEl.textContent = currentLikeCount - 1;
                } else {
                    batch.update(userDocRef, { likedContent: arrayUnion(docId) });
                    batch.update(contentDocRef, { likeCount: increment(1) });
                    likeButton.classList.add('liked');
                    likeCountEl.textContent = currentLikeCount + 1;
                }
                await batch.commit();
            } catch (error) {
                console.error("Error liking content:", error);
                showToast("Error liking. Please try again.");
                if (isCurrentlyLiked) {
                    likeButton.classList.add('liked');
                    likeCountEl.textContent = currentLikeCount;
                } else {
                    likeButton.classList.remove('liked');
                    likeCountEl.textContent = currentLikeCount;
                }
            }
        }

        // --- Handle Create Page File Upload (NOW CLOUDINARY) ---
        
        // Video File
        videoUploadBtn.addEventListener('click', () => {
            videoFileInput.click();
        });
        videoFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                selectedVideoFile = file;
                videoFileName.textContent = file.name;
                videoUploadBtn.querySelector('span').textContent = "Change Video";
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    videoPreviewPlayer.src = event.target.result;
                }
                reader.readAsDataURL(file);
                videoPreviewContainer.classList.remove('hidden');
            }
        });

        // Thumbnail File
        thumbnailUploadBtn.addEventListener('click', () => {
            thumbnailFileInput.click();
        });
        thumbnailFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                selectedThumbnailFile = file;
                thumbnailFileName.textContent = file.name;
                thumbnailUploadBtn.querySelector('span').textContent = "Change Thumbnail";
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    thumbnailPreviewImg.src = event.target.result;
                }
                reader.readAsDataURL(file);
                thumbnailPreviewContainer.classList.remove('hidden');
            }
        });

        // NEW: Generic Upload to Cloudinary (FIXED)
        async function uploadToCloudinary(file, resourceType = 'image') {
            if (!file) return null;
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
            formData.append('cloud_name', CLOUDINARY_CLOUD_NAME);
            
            // --- THIS IS THE FIX ---
            // We must tell Cloudinary what type of resource we're uploading.
            formData.append('resource_type', resourceType);
            // --- END OF FIX ---

            const url = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/${resourceType}/upload`;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                if (data.secure_url) {
                    return data.secure_url;
                } else {
                    // Provide a more detailed error
                    console.error("Cloudinary Error:", data.error.message);
                    throw new Error(data.error.message);
                }
            } catch (error) {
                console.error(`Error uploading ${resourceType}:`, error);
                showToast(`Upload Error: ${error.message}`);
                return null;
            }
        }

        // Handle Create Post (NOW WITH VIDEO & THUMBNAIL)
        createPostForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUserId) return;

            const title = document.getElementById('post-title').value;
            const postType = document.querySelector('input[name="postType"]:checked').value;

            if (!title) {
                showToast("Please add a title."); return;
            }
            if (!selectedVideoFile) {
                showToast("Please select a video file."); return;
            }
            if (!selectedThumbnailFile) {
                showToast("Please upload a thumbnail image."); return;
            }
            
            uploadBtn.disabled = true;
            uploadBtn.textContent = "Uploading Video (this may take a moment)...";

            // 1. Upload Video
            const videoUrl = await uploadToCloudinary(selectedVideoFile, 'video');
            if (!videoUrl) {
                uploadBtn.disabled = false;
                uploadBtn.textContent = "Publish Post";
                return;
            }
            
            uploadBtn.textContent = "Uploading Thumbnail...";

            // 2. Upload Thumbnail
            const thumbnailUrl = await uploadToCloudinary(selectedThumbnailFile, 'image');
            if (!thumbnailUrl) {
                uploadBtn.disabled = false;
                uploadBtn.textContent = "Publish Post";
                return;
            }

            uploadBtn.textContent = "Saving Post...";

            // 3. Save post to Firestore
            const targetColRef = (postType === 'video') ? postsColRef : reelsColRef;
            
            try {
                const batch = writeBatch(db);
                const newContentData = {
                    title: title,
                    videoUrl: videoUrl,
                    thumbnailUrl: thumbnailUrl,
                    creatorId: currentUserId,
                    creatorUsername: currentUserData.username || "AnonymousUser",
                    creatorProfilePic: currentUserData.profilePicUrl || `https://placehold.co/40x40/93c5fd/333?text=${currentUserData.username.charAt(0).toUpperCase()}`,
                    sparkCount: 0,
                    likeCount: 0,
                    createdAt: serverTimestamp()
                };
                
                if (postType === 'reel') newContentData.commentCount = 0;
                
                batch.set(doc(targetColRef), newContentData);
                const userDocRef = doc(db, "users", currentUserId);
                batch.update(userDocRef, { postCount: increment(1) });
                
                await batch.commit();
                showToast("âœ… Content Published!");
                
                // Reset the form
                createPostForm.reset();
                selectedThumbnailFile = null;
                selectedVideoFile = null;
                thumbnailPreviewContainer.classList.add('hidden');
                videoPreviewContainer.classList.add('hidden');
                thumbnailUploadBtn.querySelector('span').textContent = "Upload Thumbnail";
                videoUploadBtn.querySelector('span').textContent = "Select Video File";

                if (postType === 'video') document.getElementById('nav-home').click();
                else document.getElementById('nav-reels').click();

            } catch (error) {
                console.error("Error uploading post: ", error);
                showToast("Upload failed. Please try again.");
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = "Publish Post";
            }
        });

        // --- Account Page Edit/Save Logic ---
        editProfileBtn.addEventListener('click', () => {
            // Pre-fill with current data from the `currentUserData` object
            displaynameInput.value = currentUserData.displayName; // FIX: Was usernameInput
            usernameDisplayDisabled.value = `@${currentUserData.username}`; // NEW
            bioInput.value = currentUserData.bio;
            profilePicUrlInput.value = currentUserData.profilePicUrl;
            profileEditPicImgEl.src = currentUserData.profilePicUrl || `https://placehold.co/100x100/fca5a5/333?text=${currentUserData.username.charAt(0).toUpperCase()}`;

            profileViewEl.classList.add('hidden');
            profileEditViewEl.classList.remove('hidden');
        });
        cancelEditBtn.addEventListener('click', () => {
            profileViewEl.classList.remove('hidden');
            profileEditViewEl.classList.add('hidden');
            
            // Reset values to current data
            displaynameInput.value = currentUserData.displayName;
            bioInput.value = currentUserData.bio;
            profilePicUrlInput.value = currentUserData.profilePicUrl;
            profileEditPicImgEl.src = currentUserData.profilePicUrl || `https://placehold.co/100x100/fca5a5/333?text=${currentUserData.username.charAt(0).toUpperCase()}`;
        });
        saveProfileBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            if (!currentUserId) return;
            const newDisplayName = displaynameInput.value; // FIX: Was usernameInput
            const newBio = bioInput.value;
            const newPicUrl = profilePicUrlInput.value;
            
            if (!newDisplayName) {
                showToast("Display Name cannot be empty.");
                return;
            }
            
            saveProfileBtn.disabled = true;
            saveProfileBtn.textContent = "Saving...";
            const userDocRef = doc(db, "users", currentUserId);
            try {
                await updateDoc(userDocRef, {
                    displayName: newDisplayName, // Save display name
                    bio: newBio,
                    profilePicUrl: newPicUrl
                });
                showToast("Profile saved successfully!");
                profileViewEl.classList.remove('hidden');
                profileEditViewEl.classList.add('hidden');
            } catch (error) {
                console.error("Error saving profile:", error);
                showToast("Error saving profile. Try again.");
            } finally {
                saveProfileBtn.disabled = false;
                saveProfileBtn.textContent = "Save Changes";
            }
        });

        profilePicUrlInput.addEventListener('input', () => {
            profileEditPicImgEl.src = profilePicUrlInput.value || `https://placehold.co/100x100/fca5a5/333?text=?`;
        });

        // --- PAGE NAVIGATION ---
        const navButtons = document.querySelectorAll('.nav-button');
        const pages = document.querySelectorAll('.page-content');

        navButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                e.preventDefault();
                const targetPageId = button.dataset.page;
                
                if (targetPageId === 'reels-page') {
                    mainHeader.style.display = 'none';
                    bodyEl.classList.add('reels-active');
                    document.getElementById('reels-page').classList.add('reels-active');
                } else {
                    mainHeader.style.display = 'block';
                    bodyEl.classList.remove('reels-active');
                    document.getElementById('reels-page').classList.remove('reels-active');
                }
                
                // Hide all pages
                pages.forEach(page => {
                    if (page.id !== 'login-page' && page.id !== 'complete-profile-page') {
                        page.style.display = 'none';
                    }
                });
                
                const targetPage = document.getElementById(targetPageId);
                if (targetPage) targetPage.style.display = 'block';

                navButtons.forEach(btn => {
                    btn.classList.remove('text-indigo-600', 'font-medium');
                    btn.classList.add('text-gray-500');
                });
                button.classList.add('text-indigo-600', 'font-medium');
                button.classList.remove('text-gray-500');

                if (targetPageId !== 'reels-page') window.scrollTo(0, 0);
            });
        });
        
        document.getElementById('desktop-create-btn').addEventListener('click', () => {
             document.getElementById('nav-create').click();
        });

        // --- MODAL (How to Earn) ---
        openModalBtn.addEventListener('click', () => {
            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.querySelector('.modal-content').classList.remove('-translate-y-10');
        });
        closeModalBtn.addEventListener('click', () => {
            modal.classList.add('opacity-0', 'pointer-events-none');
            modal.querySelector('.modal-content').classList.add('-translate-y-10');
        });
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModalBtn.click();
        });
        
        // --- VIDEO MODAL (Home Page) ---
        closeVideoModalBtn.addEventListener('click', () => {
            videoPlayerModal.classList.add('opacity-0', 'pointer-events-none');
            videoPlayerModal.querySelector('.modal-content').classList.add('-translate-y-10');
            modalVideoPlayer.pause();
            modalVideoPlayer.src = ""; // Clear src
        });
        videoPlayerModal.addEventListener('click', (e) => {
            if (e.target === videoPlayerModal) closeVideoModalBtn.click();
        });

        // --- START THE APP ---
        initializeFirebase();

    </script>
</body>
</html>


